---

# 绳墨 - 高度可定制化的本地AI聊天前端

[![版本](https://img.shields.io/badge/版本-开发中-blue.svg)](https://shields.io/) [![语言](https://img.shields.io/badge/语言-Python_&_JavaScript-orange.svg)](https://shields.io/) [![界面](https://img.shields.io/badge/界面-Web-brightgreen.svg)](https://shields.io/)

**绳墨** 是一款专为深度角色扮演和个性化AI交互设计的本地Web应用程序。它提供了一个简洁、高效、高度可配置的操作界面，作为Google Gemini API和NovelAI API的本地前端，致力于实现复杂的角色互动逻辑、动态情境管理和流畅的多模态（文本、图片）交互体验。

本项目的设计哲学是 **轻量、本地、可控、可定制**。所有核心数据（配置、聊天记录、角色卡、小说文本等）均存储在本地，确保用户数据的私密性和所有权。通过高度模块化的设置项和强大的占位符系统，用户可以精细调整AI的行为模式，创造独一无二的交互场景。

## ✨ 核心功能亮点

### 🚀 高级聊天体验

*   **多聊天室管理**：支持创建、切换、重命名、导入/导出和删除多个独立的聊天室。每个聊天室拥有完全隔离的历史记录、角色配置、激活小说、世界信息和背景图片。
*   **流畅交互界面**：采用移动端优先设计 (`gemini_chat.html`)，界面紧凑，元素排布合理，确保在小屏幕设备上也能获得良好体验。同时提供桌面端简洁的编辑器界面 (`editor.html`)。
*   **实时运行控制**：通过“运行/暂停”按钮，用户可以随时中断或恢复AI角色的自动响应流程，便于在复杂场景中进行手动干预或调整。
*   **精细消息操作**：
    *   **原始/格式化切换**：一键查看AI返回的原始JSON数据或经过解析后的格式化文本。
    *   **消息编辑**：支持直接在界面上编辑已发送或已接收的消息内容（包括用户、AI角色、工具的文本输出）。
    *   **消息删除**：可单独删除某条消息，或删除某条消息及其之后的所有消息。
*   **加载与重试指示**：清晰的加载动画指示AI请求状态，并在API密钥轮询重试时提供视觉反馈。
*   **管理员快捷入口**：提供“管理员”角色快速发言入口，方便进行元指令输入或场景描述。
*   **用户自定义背景**：每个聊天室均可独立设置背景图片，增强沉浸感。

### 🎭 强大的角色扮演支持

*   **角色卡管理**：
    *   支持在聊天室内创建、编辑、删除永久角色。
    *   提供角色设定、角色记忆、角色绘图模板等专属字段。
    *   支持将角色导出为JSON文件，或从JSON文件导入角色。
*   **动态角色状态**：
    *   引入 **“默 (默认)”**、**“活 (活跃)”**、**“用 (用户控制)”**、**“更 (更新中)”** 四种核心状态。
    *   只有“活”状态的角色会由AI自动驱动响应。
    *   “用”状态的角色会暂停AI驱动，等待用户手动编辑输入。
    *   “更”状态用于标记角色正在被“角色更新大师”处理。
    *   状态切换直观，便于控制场景中的角色行为权。
*   **临时角色机制**：支持在运行时动态添加和移除临时角色，无需预先创建角色文件，极大增加了场景的灵活性。临时角色同样拥有独立状态。
*   **角色按钮与快捷操作**：
    *   主界面提供角色快捷按钮列表，点击可快速切换角色状态或进入编辑。
    *   长按角色主按钮可直接跳转至该角色的详细设定页面。
    *   长按角色状态按钮（如“用”、“默”）可触发特定快捷操作（如为“用”状态角色创建编辑框、删除临时角色等）。
*   **扮演规则与公共信息**：每个聊天室可独立配置“扮演规则”和“公共信息”，这些信息会通过占位符注入到AI的提示词中，用于指导整体扮演风格和共享场景知识。

### 🛠️ 多功能AI工具集 (“大师”系列)

*   **可插拔工具系统**：内置多个专门设计的AI工具（“大师”），每个工具均可独立启用/禁用、配置专属的Gemini模型、响应格式(Schema)、专属数据库(上下文信息)和主提示词。
*   **绘图大师 (`drawingMaster`)**：
    *   接收结构化指令（包含角色、场景、风格等标签）。
    *   调用NovelAI API代理进行图像生成。
    *   自动将生成的图片嵌入聊天记录中。
    *   支持从聊天气泡中直接将生成的图片设为聊天室背景。
    *   支持针对失败或不满意的图片进行“重绘”操作。
*   **游戏主持人 (`gameHost`)**：
    *   设计用于驱动基于规则的场景互动或桌面角色扮演游戏(TRPG)。
    *   输出结构化信息，包含场景描述、时间推进、角色状态更新、行动结果判定等。
    *   支持在聊天气泡内分标签页（时间、地点、角色）展示结构化信息，保持界面整洁。
    *   能够根据游戏逻辑动态更新角色的“详细状态”。
    *   能够根据游戏逻辑动态添加或移除临时角色，或改变现有角色的状态。
*   **写作大师 (`writingMaster`)**：
    *   专注于提供环境描写、感官细节或其他叙事性文本。
    *   可在包含特定感官词（如“看”、“听”）的用户输入后自动触发（如果启用）。
*   **角色更新大师 (`characterUpdateMaster`)**：
    *   接收指定角色的名称作为目标。
    *   根据最近的对话历史，分析并生成该角色更新后的“角色记忆”和“角色设定”。
    *   提供预览，用户确认后可一键将更新保存回对应的永久角色文件。
    *   极大地便利了在长对话中保持角色信息的一致性和发展性。
*   **私人助理 (`privateAssistant`)**：
    *   作为一个通用的、可定制的工具接口。
    *   可通过长按“运行/暂停”按钮触发。
    *   适用于执行不属于其他特定工具范畴的任务，如总结信息、提供建议等。

### 📚 集成小说阅读与参考

*   **小说导入与处理**：支持直接粘贴小说文本，后端自动进行分段处理，并尝试提取章节信息生成目录。
*   **聊天室内小说管理**：可在聊天室设置中管理已导入的小说，支持重命名和删除。
*   **小说激活与关联**：可将一本或多本小说与当前聊天室“激活”关联。
*   **集成阅读界面**：
    *   提供独立的小说阅读界面，可在聊天界面和阅读界面间轻松切换。
    *   支持书架视图，展示当前聊天室所有关联小说，并可选择当前阅读的小说和激活/反激活小说。
    *   支持目录视图，快速跳转到指定章节。
    *   自动记录并恢复每个聊天室每本激活小说的最后阅读位置。
*   **动态参考文本**：激活的小说内容会根据当前阅读位置动态截取片段，并通过 `{{参考文本}}` 占位符注入到AI提示词中，为AI提供丰富的背景知识和上下文参考。参考文本的长度可配置。

### ⚙️ 深度定制与配置

*   **全面的设置面板**：提供一个多层级的设置面板，涵盖所有可配置项。
*   **API与模型配置**：
    *   支持配置多个Google Gemini API密钥，自动轮询使用并记录失败次数。
    *   支持配置NovelAI API密钥。
    *   自动获取并允许为主要聊天、各个工具分别选择不同的可用Gemini模型。
    *   可精细调整Gemini模型的生成参数（Temperature, Top P, Top K, Max Output Tokens）。
    *   可配置NovelAI的各项绘图参数（模型、尺寸、步数、采样器、引导系数等）。
*   **提示词工程**：
    *   **系统指令 (System Instruction)**：全局性的顶层指令。
    *   **多轮提示词预设 (Prompt Preset Turns)**：可构建复杂的多轮对话历史作为每次请求的基础上下文。支持导出和导入预设配置。
    *   **响应格式化 (Response Schema)**：支持为主要聊天和各工具配置JSON Schema，强制AI按特定结构输出。同时支持配置JavaScript解析器函数，用于在前端处理和展示结构化数据。
    *   **共享数据库指令**：为角色和临时角色提供共享的上下文信息或指令。
    *   **工具专属数据库指令**：每个工具可以拥有自己独立的上下文信息或指令。
    *   **主提示词**：为角色/临时角色以及每个工具配置核心的任务指令。
*   **强大的占位符系统**：几乎所有提示词相关字段（系统指令、预设、数据库、主提示词等）均支持占位符替换，如 `{{角色名称}}`, `{{角色设定}}`, `{{角色记忆}}`, `{{角色状态}}`, `{{消息记录}}`, `{{世界信息}}`, `{{参考文本}}`, `{{扮演规则}}`, `{{公共信息}}` 等，实现高度动态和情境感知的提示词构建。

### 💾 便捷的数据管理

*   **本地文件存储**：所有配置、聊天记录、角色、小说数据均以JSON文件的形式存储在本地 `chatrooms` 目录下，易于理解、备份和迁移。生成的图片存储在 `images/generated` 目录下。
*   **聊天室导出/导入**：支持将单个聊天室的所有相关数据（配置、历史、角色、小说、背景图等）打包成ZIP文件导出，或从ZIP文件导入。导入时自动处理命名冲突。
*   **完整配置导出/导入**：支持将整个应用的所有配置和所有聊天室数据打包成一个ZIP文件，方便整体备份和恢复。
*   **角色导出/导入**：支持单独导出或导入角色卡文件（JSON）。
*   **提示词预设导出/导入**：支持将复杂的提示词配置（系统指令、多轮预设、共享配置、工具配置）导出为JSON文件，方便分享和复用。
*   **数据清理**：提供一键清空当前聊天室历史记录的功能，以及一个危险但方便的“清空全部配置”选项，用于重置整个应用。
*   **自动保存**：大部分配置更改都会在短时间延迟后自动保存到本地文件，减少数据丢失风险。

### 🔒 本地优先与隐私

*   **核心服务本地运行**：`backend.py` 在本地运行，仅在需要时代理请求到Gemini或NovelAI的官方API。
*   **数据本地存储**：如前所述，所有用户生成的数据和配置都存储在本地设备上。
*   **API密钥本地管理**：API密钥存储在浏览器的LocalStorage中，或通过配置文件管理，不经过第三方服务器。

---
